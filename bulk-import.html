<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Import | BasketStat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="app-header">
    <div>
      <h1>Bulk Data Import</h1>
      <p>Clear and rebuild data from CSV files</p>
    </div>
    <nav style="display: flex; gap: 16px; align-items: center;">
      <a href="admin.html">Back to Admin</a>
      <button onclick="logout()" title="Sign Out" style="background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-muted); transition: color 0.2s;" onmouseover="this.style.color='var(--negative)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
      </button>
    </nav>
  </header>

  <main class="app-shell" style="grid-template-columns: 1fr;">
    <section class="panel">
      <h2>Step 1: Clear Existing Data</h2>
      <p style="color: var(--text-secondary); margin-bottom: 16px;">
        This will remove all games and player data from localStorage.
      </p>
      <button id="clearBtn" class="danger secondary">Clear All Data</button>
      <div id="clearStatus" style="margin-top: 12px; color: var(--text-muted);"></div>
    </section>

    <section class="panel">
      <h2>Step 2: Import CSV Files</h2>
      <p style="color: var(--text-secondary); margin-bottom: 16px;">
        Select all your CSV files to import. Each file needs game metadata.
      </p>
      
      <div id="importList"></div>
      
      <div class="field" style="margin-top: 16px;">
        <label for="csvFiles">Select CSV Files</label>
        <input type="file" id="csvFiles" accept=".csv" multiple />
      </div>
      
      <div id="fileList" style="margin-top: 16px;"></div>
      
      <button id="importBtn" style="margin-top: 16px;" disabled>Import All Files</button>
      <div id="importStatus" style="margin-top: 12px;"></div>
    </section>

    <section class="panel">
      <h2>Step 3: Verify Results</h2>
      <div id="results"></div>
      <button id="verifyBtn" class="secondary" style="margin-top: 16px;">Refresh Player Counts</button>
    </section>
  </main>

  <script src="config.js"></script>
  <script src="data.js"></script>
  <script>
    const clearBtn = document.getElementById('clearBtn');
    const clearStatus = document.getElementById('clearStatus');
    const csvFilesInput = document.getElementById('csvFiles');
    const fileList = document.getElementById('fileList');
    const importBtn = document.getElementById('importBtn');
    const importStatus = document.getElementById('importStatus');
    const results = document.getElementById('results');
    const verifyBtn = document.getElementById('verifyBtn');

    let selectedFiles = [];
    let gameMetadata = {};

    // Game metadata from filenames (you can edit these)
    const knownGames = {
      'box-scores-11 Oct 2025.csv': { date: '2025-10-11', opponent: 'Fredrikstad', league: '1. divisjon', homeAway: 'home' },
      'box-scores-18 Oct 2025.csv': { date: '2025-10-18', opponent: 'Eidsvoll', league: '1. divisjon', homeAway: 'away' },
      'box-scores-14 Nov 2025.csv': { date: '2025-11-14', opponent: 'Asker', league: '1. divisjon', homeAway: 'away' },
      'box-scores-22 Nov 2025.csv': { date: '2025-11-22', opponent: 'Haugerud Hawks', league: '1. divisjon', homeAway: 'home' },
      'box-scores-29 Nov 2025.csv': { date: '2025-11-29', opponent: 'Oppsal', league: '1. divisjon', homeAway: 'away' },
      'box-scores-30 Nov 2025.csv': { date: '2025-11-30', opponent: 'Bislett', league: '1. divisjon', homeAway: 'home' },
      'box-scores-6 Dec 2025.csv': { date: '2025-12-06', opponent: 'Skien', league: '1. divisjon', homeAway: 'away' },
      'box-scores-13 Dec 2025.csv': { date: '2025-12-13', opponent: 'Asker', league: '1. divisjon', homeAway: 'home' },
      'box-scores-14 Dec 2025.csv': { date: '2025-12-14', opponent: 'Oppsal', league: '1. divisjon', homeAway: 'home' },
      'box-scores-10 Jan 2026.csv': { date: '2026-01-10', opponent: 'Bislet', league: '1. divisjon', homeAway: 'away' },
      'box-scores-17 Jan 2026.csv': { date: '2026-01-17', opponent: 'Asker', league: '1. divisjon', homeAway: 'home' },
    };

    // Clear data
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear ALL stored data? This cannot be undone.')) {
        window.basketStatData.saveData({ players: {}, games: [] });
        clearStatus.innerHTML = '<span style="color: var(--positive);">✓ Data cleared</span>';
        updateResults();
      }
    });

    // File selection
    csvFilesInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      renderFileList();
    });

    // Escape HTML to prevent XSS
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function renderFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '<p style="color: var(--text-muted);">No files selected</p>';
        importBtn.disabled = true;
        return;
      }

      // Build table structure
      const table = document.createElement('div');
      table.innerHTML = '<h3 style="margin-bottom: 12px;">Files to import:</h3>' +
        '<div class="data-table"><table><thead><tr><th>File</th><th>Date</th><th>Opponent</th><th>League</th><th>H/A</th></tr></thead><tbody id="fileTableBody"></tbody></table></div>';
      
      fileList.innerHTML = '';
      fileList.appendChild(table);
      
      const tbody = document.getElementById('fileTableBody');
      
      selectedFiles.forEach((file, index) => {
        const meta = knownGames[file.name] || { date: '', opponent: '?', league: '?', homeAway: '?' };
        gameMetadata[file.name] = meta;
        
        const tr = document.createElement('tr');
        tr.dataset.fileIndex = index;
        
        // Filename cell (escaped)
        const tdName = document.createElement('td');
        tdName.textContent = file.name;
        tr.appendChild(tdName);
        
        // Date input
        const tdDate = document.createElement('td');
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.value = meta.date;
        dateInput.style.width = '130px';
        dateInput.dataset.field = 'date';
        tdDate.appendChild(dateInput);
        tr.appendChild(tdDate);
        
        // Opponent input
        const tdOpponent = document.createElement('td');
        const opponentInput = document.createElement('input');
        opponentInput.type = 'text';
        opponentInput.value = meta.opponent;
        opponentInput.style.width = '120px';
        opponentInput.dataset.field = 'opponent';
        tdOpponent.appendChild(opponentInput);
        tr.appendChild(tdOpponent);
        
        // League input
        const tdLeague = document.createElement('td');
        const leagueInput = document.createElement('input');
        leagueInput.type = 'text';
        leagueInput.value = meta.league;
        leagueInput.style.width = '100px';
        leagueInput.dataset.field = 'league';
        tdLeague.appendChild(leagueInput);
        tr.appendChild(tdLeague);
        
        // Home/Away select
        const tdHomeAway = document.createElement('td');
        const homeAwaySelect = document.createElement('select');
        homeAwaySelect.dataset.field = 'homeAway';
        homeAwaySelect.innerHTML = `
          <option value="home" ${meta.homeAway === 'home' ? 'selected' : ''}>Home</option>
          <option value="away" ${meta.homeAway === 'away' ? 'selected' : ''}>Away</option>
        `;
        tdHomeAway.appendChild(homeAwaySelect);
        tr.appendChild(tdHomeAway);
        
        tbody.appendChild(tr);
      });
      
      // Event delegation for all inputs/selects
      tbody.addEventListener('change', (e) => {
        const field = e.target.dataset.field;
        if (!field) return;
        
        const row = e.target.closest('tr');
        const fileIndex = parseInt(row.dataset.fileIndex, 10);
        const file = selectedFiles[fileIndex];
        
        if (file && gameMetadata[file.name]) {
          gameMetadata[file.name][field] = e.target.value;
        }
      });
      
      importBtn.disabled = false;
    }

    // Import all files
    importBtn.addEventListener('click', async () => {
      importBtn.disabled = true;
      importStatus.innerHTML = '<p>Importing...</p>';
      
      let imported = 0;
      let errors = [];

      for (const file of selectedFiles) {
        const meta = gameMetadata[file.name];
        if (!meta.date || !meta.opponent) {
          errors.push(`${file.name}: Missing date or opponent`);
          continue;
        }

        try {
          const { performances, playersFound } = await window.basketStatData.parseCsv(file);
          const playerCount = Object.keys(performances).length;
          
          if (playerCount === 0) {
            errors.push(`${file.name}: No valid players found`);
            continue;
          }

          window.basketStatData.addGame({
            date: meta.date,
            opponent: meta.opponent,
            league: meta.league || '',
            homeAway: meta.homeAway || 'home',
            performances,
            playersFound,
            csvFile: file.name
          });

          imported++;
          importStatus.innerHTML = `<p>Imported ${imported}/${selectedFiles.length} files...</p>`;
        } catch (err) {
          errors.push(`${file.name}: ${err.message}`);
        }
      }

      let statusHtml = `<p style="color: var(--positive);">✓ Successfully imported ${imported} games</p>`;
      if (errors.length > 0) {
        statusHtml += `<p style="color: var(--negative);">Errors:</p><ul style="color: var(--negative);">` +
          errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
      }
      importStatus.innerHTML = statusHtml;
      importBtn.disabled = false;
      updateResults();
    });

    // Verify results
    function updateResults() {
      const counts = window.basketStatData.getPlayerGameCounts();
      const { games } = window.basketStatData.loadData();
      
      const sorted = Object.entries(counts).sort(([,a], [,b]) => b - a);
      
      results.innerHTML = `
        <p style="margin-bottom: 16px;"><strong>Total Games:</strong> ${games.length}</p>
        <h3 style="margin-bottom: 12px;">Player Game Counts:</h3>
        <div class="data-table"><table>
          <thead><tr><th>Player</th><th>Games</th></tr></thead>
          <tbody>
            ${sorted.map(([name, count]) => `<tr><td>${name}</td><td>${count}</td></tr>`).join('')}
          </tbody>
        </table></div>
        <p style="margin-top: 12px; color: var(--text-muted);">Total: ${sorted.length} players</p>
      `;
    }

    verifyBtn.addEventListener('click', updateResults);
    updateResults();
  </script>
</body>
</html>
